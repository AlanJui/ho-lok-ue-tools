(window.webpackJsonp=window.webpackJsonp||[]).push([[205],{490:function(s,a,e){"use strict";e.r(a);var t=e(10),r=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"postgresql-server-自救手冊"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#postgresql-server-自救手冊"}},[s._v("#")]),s._v(" PostgreSQL Server 自救手冊")]),s._v(" "),a("hr"),s._v(" "),a("h1",{attrs:{id:"完成安裝後"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#完成安裝後"}},[s._v("#")]),s._v(" 完成安裝後")]),s._v(" "),a("h2",{attrs:{id:"變更預設管理員帳號-postgres-的密碼"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#變更預設管理員帳號-postgres-的密碼"}},[s._v("#")]),s._v(" 變更預設管理員帳號 postgres 的密碼")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("psql postgres\n\\du\n\\password postgres\n")])])]),a("h2",{attrs:{id:"建立app用資料庫"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#建立app用資料庫"}},[s._v("#")]),s._v(" 建立App用資料庫")]),s._v(" "),a("p",[s._v("查詢使用者帳號：查詢 Postgres Server 所擁有的使用者帳號")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\du\n")])])]),a("p",[s._v("建立使用者帳號（db_user)")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("create role db_user with login password 'Passw0rd';\n")])])]),a("p",[s._v("允許 db_user 帳號，具建立DB權限")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("alter role db_user createdb;\n")])])]),a("p",[s._v("透過「查詢使用者帳號指令」，確認使用者帳號已建立。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\du\n\\q\n")])])]),a("p",[s._v("以 db_user 帳號，進入 psql")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("psql postgres -U db_user\\\n")])])]),a("p",[s._v("建立資料庫")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("create database my_test_db;\n")])])]),a("p",[s._v("確認資料庫已建立")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\l\n")])])]),a("p",[s._v("設定 db_user 在 my_test_db 資料庫擁有所有權限")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("grant all privileges on database my_test_db to db_user;\n")])])]),a("p",[s._v("確認 db_user 已能連上 my_test_db 資料庫")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\connect my_test_db;\n")])])]),a("p",[s._v("查詢資料已建立之 Tables")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\dt\n")])])]),a("p",[s._v("離開 psql")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\q\n")])])]),a("hr"),s._v(" "),a("h1",{attrs:{id:"在-docker-container-環境運作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在-docker-container-環境運作"}},[s._v("#")]),s._v(" 在 Docker Container 環境運作")]),s._v(" "),a("p",[s._v("https://hub.docker.com/_/postgres/")]),s._v(" "),a("h1",{attrs:{id:"下載postgresql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下載postgresql"}},[s._v("#")]),s._v(" 下載PostgreSQL")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("docker pull postgres\n")])])]),a("h1",{attrs:{id:"啟動-postgresql-instance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#啟動-postgresql-instance"}},[s._v("#")]),s._v(" 啟動 PostgreSQL Instance")]),s._v(" "),a("h2",{attrs:{id:"start-a-postgres-instance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#start-a-postgres-instance"}},[s._v("#")]),s._v(" start a postgres instance")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("docker run --name some-postgres -e POSTGRES_PASSWORD=mysecretpassword -d postgres\n\n\n\ndocker run --name psql-db -e POSTGRES_PASSWORD=Passw0rd -d postgres\n\n\ndocker run --name psql-db -e POSTGRES_PASSWORD=Passw0rd -p 5432:5432 postgres:10\n")])])]),a("h2",{attrs:{id:"connect-to-it-from-an-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#connect-to-it-from-an-application"}},[s._v("#")]),s._v(" connect to it from an application")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ docker run --name some-app --link some-postgres:postgres -d application-that-uses-postgres\n\n\ndocker run --name psql-db --link db:postgres -d psql -h postgres -U postgres\n\n\ndocker run --link db:postgres -d --name psql-db -e POSTGRES_PASSWORD=Passw0rd -p 5432:5432 postgres:10\n")])])]),a("p",[s._v("驗證 Container 已能正常運作")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('docker ps\n\n\nAlanJui at MacBook-Pro.local in [~/workspace/django]\n21:59:30 $ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED                  STATUS              PORTS                    NAMES\n5c5bf208b44a        postgres:10         "docker-entrypoint.s…"   Less than a second ago   Up 3 seconds        0.0.0.0:5432->5432/tcp   psql-db\n')])])]),a("p",[s._v("執行 PSQL")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('docker run -it --rm --link some-postgres:postgres postgres psql -h postgres -U postgres\n\n\nAlanJui at MacBook-Pro.local in [~/workspace/django]\n22:04:42 $ docker exec -it psql-db bash\nroot@5c5bf208b44a:/# psql -h localhost -U postgres\npsql (10.4 (Debian 10.4-2.pgdg90+1))\nType "help" for help.\n\npostgres=# \\q\nroot@5c5bf208b44a:/# exit\nexit\n\nAlanJui at MacBook-Pro.local in [~/workspace/django]\n22:16:04 $\n')])])]),a("hr"),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("docker stack deploy -c stack.yml postgres\n\n\ndocker-compose -f stack.yml up\n\n\nhttp://<swarm-ip>:8080\n\n\nhttp://localhost:8080\n\n\nhttp://<host-ip>:8080\n")])])]),a("p",[s._v("stack.yml")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("# Use postgres/example user/password credentials\nversion: '3.1'\n\nservices:\n\n  db:\n    image: postgres\n    restart: always\n    environment:\n      POSTGRES_PASSWORD: Passw0rd\n\n  adminer:\n    image: adminer\n    restart: always\n    ports:\n      - 8080:8080\n")])])]),a("hr"),s._v(" "),a("h1",{attrs:{id:"在-ubuntu-16-04-環境運作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在-ubuntu-16-04-環境運作"}},[s._v("#")]),s._v(" 在 Ubuntu 16.04 環境運作")]),s._v(" "),a("p",[s._v("安裝指令。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("sudo apt-get update\nsudo apt-get install postgresql postgresql-contrib\n\n\nCreating new cluster 9.5/main ...\n  config /etc/postgresql/9.5/main\n  data   /var/lib/postgresql/9.5/main\n  locale en_US.UTF-8\n  socket /var/run/postgresql\n  port   5432\n")])])]),a("p",[s._v("系統安裝路徑：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("/usr/share/postgresql/9.5/\n/usr/share/postgresql-common/\n")])])]),a("p",[s._v("設定檔存放路徑：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("/etc/postgresql/9.5/main/postgresql.conf\n")])])]),a("p",[s._v("資料庫存放路徑：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("/var/lib/postgresql/9.5/main\n")])])]),a("p",[s._v("Service 管理常用指令：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("sudo service postgresql status (systemctl status postgresql)\nsudo service postgresql stop (sudo systemctl stop postgresql)\nsudo service postgresql start (sudo systemctl start postgresql) \nsudo service postgresql restart (sudo systemctl restart postgresql) \n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"變更-port-號作業"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#變更-port-號作業"}},[s._v("#")]),s._v(" 變更 Port 號作業")]),s._v(" "),a("p",[s._v("設定檔： /etc/postgresql/"),a("Ver",[s._v("/main/postgresql.conf")])],1),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("...\nport = 5433\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"變更預設管理員帳號密碼作業"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#變更預設管理員帳號密碼作業"}},[s._v("#")]),s._v(" 變更預設管理員帳號密碼作業")]),s._v(" "),a("p",[s._v("將 PostgreSQL 資料庫系統，預設的管理員帳號：postgres，設定密碼。")]),s._v(" "),a("p",[a("strong",[s._v("驗證作業系統已有 postgres 使用者帳號被建立。")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ id postgres\nuid=124(postgres) gid=131(postgres) \\u7fa4\\u7d44=131(postgres),112(ssl-cert)\n")])])]),a("p",[s._v("變更「使用作業系統使用者」的密碼")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo passwd postgres\n")])])]),a("p",[s._v("變更「PostgreSQL資料庫系統使用者（postgres）」的密碼")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo -u postgres psql -d template1 -c \"ALTER USER postgres WITH PASSWORD 'ChingHai99@';\"\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"設定可遠端存取作業"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#設定可遠端存取作業"}},[s._v("#")]),s._v(" 設定可遠端存取作業")]),s._v(" "),a("p",[a("strong",[s._v("(1)　設定 PostgreSQL 相關「設定檔」：")])]),s._v(" "),a("p",[s._v("設定檔目錄路徑：/etc/postgresql/9.5/main/")]),s._v(" "),a("p",[s._v("在檔案： "),a("strong",[s._v("pg_hba.conf ，加入下列設定：")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("host all all 192.168.66.0/24 md5\n")])])]),a("p",[s._v("在檔案： "),a("strong",[s._v("postgresql.conf，加入下列設定：")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("listen_addresses='*'\n")])])]),a("p",[a("strong",[s._v("(2) 開通防火牆")])]),s._v(" "),a("p",[s._v("要求「防火牆」開放 PORT: 5432\n檢查防火牆的 Port：5432 是否已開通： "),a("a",{attrs:{href:"http://www.yougetsignal.com/tools/open-ports/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://www.yougetsignal.com/tools/open-ports/"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("執行下列指令，要求防火牆將 Port: 5432 開通（意即在 "),a("code",[s._v("iptables")]),s._v(" 新增 rule）")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("iptables -A INPUT -s 0/0 -p tcp --dport 5432 -j ACCEPT\n")])])]),a("p",[a("strong",[s._v("(3) 從新啟動 PostgreSQL Service")])]),s._v(" "),a("p",[s._v("在Server端，將 PostgreSQL Service 重新啟動：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("sudo service postgresql restart\nsudo service postgresql status\n")])])]),a("p",[a("strong",[s._v("(4) 驗證可自遠端連入")])]),s._v(" "),a("p",[s._v("在 Client 端，連入 PostgreSQL Server：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v(" psql -U postgres postgres -h 192.168.66.10\n ...\n \\q\n")])])]),a("hr"),s._v(" "),a("p",[a("strong",[s._v("以 postgres 使用者身份啟動 postgres 管理工具：psql")])]),s._v(" "),a("p",[s._v("直接使用目前使用者：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo -u postgres psql\n")])])]),a("p",[s._v("先切換到 postgres 使用者：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo -i -u postgres\n$ psql\n")])])]),a("p",[s._v("退出 psql")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("postgres=# \\q\n")])])]),a("hr"),s._v(" "),a("p",[a("strong",[s._v("建立資料庫使用者（Create a New Role）")])]),s._v(" "),a("p",[s._v("使用指令： createuser 。對於指令用法，需要說明時，可用以下方式查明：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ man createuser\n")])])]),a("p",[s._v("【方法一】：使用登入系統的使用者身份")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo -u postgres createuser --interactive\nEnter name of role to add: app_user\nShall the new role be a superuser? (y/n) y\n")])])]),a("p",[s._v("【方法二】：切換成 postgres 使用者身份")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo -i -u postgres\npostgres@srv-01:~$ createuser --interactive\n")])])]),a("p",[s._v("【方法三】：切換成作業系統使用者 postgres 身份")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('$ su - postgres\n密碼： \npostgres@srv-01:~$\n\npostgres@srv-01:~$ createdb mytestdb\npostgres@srv-01:~$ psql mytestdb\npsql (9.5.12)\nType "help" for help.\n\nmytestdb=# \\q\npostgres@srv-01:~$ \n\npostgres@srv-01:~$ su alanjui\nPassword: \nalanjui@srv-01:/var/lib/postgresql$ \n')])])]),a("hr"),s._v(" "),a("p",[s._v("刪除 PostgreSQL 資料庫庫管理系統中的使用者： dropuser")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ su - postgres\n密碼： \npostgres@srv-01:~$ dropuser app_user\npostgres@srv-01:~$ \n")])])]),a("hr"),s._v(" "),a("p",[s._v("建立資料庫（Create a New Database）")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("sudo -u postgres createdb my_project\n\n\n\n$ sudo adduser app_db\n\n$ sudo -u postgres createuser --interactive\nEnter name of role to add: app_db\nShall the new role be a superuser? (y/n) y\n\n$ sudo -u app_db createdb app_db\n")])])]),a("hr"),s._v(" "),a("p",[s._v("應用案例：建立一個資料庫： app_db ，其資料管理員帳號為： app_user (密碼：changeme)")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('$ su - postgres\n密碼： \npostgres@srv-01:~$\n\npostgres@srv-01:~$ createuser app_user --pwprompt\nEnter password for new role: \nEnter it again: \npostgres@srv-01:~$ \n\npostgres@srv-01:~$ createdb app_db\npostgres@srv-01:~$ \n\npostgres@srv-01:~$ psql app_db\npsql (9.5.12)\nType "help" for help.\n\napp_db=# GRANT ALL ON DATABASE app_db TO app_user;\nGRANT\napp_db=# \\q\npostgres@srv-01:~$ \n')])])]),a("hr"),s._v(" "),a("h1",{attrs:{id:"在-os-x-環境運作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在-os-x-環境運作"}},[s._v("#")]),s._v(" 在 OS X 環境運作")]),s._v(" "),a("h2",{attrs:{id:"_1-安裝作業"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安裝作業"}},[s._v("#")]),s._v(" (1) 安裝作業")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("下載：使用 "),a("strong",[s._v("EnterpriseDB 套件安裝，下載處：")]),s._v(" https://www.enterprisedb.com/downloads/postgres-postgresql-downloads#linux")])]),s._v(" "),a("li",[a("p",[s._v("安裝處： ~/Applications/PostgreSQL/9.6")])]),s._v(" "),a("li",[a("p",[s._v("設定檔存放路徑： ~~/Applications/PostgreSQL/9.6/data")])]),s._v(" "),a("li",[a("p",[s._v("執行檔存放路徑： ~/Applications/PostgreSQL/9.6/bin")])]),s._v(" "),a("li",[a("p",[s._v("Service 檔存放路徑：/lib/systemd/system/postgresql-9.6.service")])])]),s._v(" "),a("h2",{attrs:{id:"_2-檢驗及確認-postgresql-server-是否已啟動"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-檢驗及確認-postgresql-server-是否已啟動"}},[s._v("#")]),s._v(" (2) 檢驗及確認 PostgreSQL Server 是否已啟動")]),s._v(" "),a("p",[s._v("透過目錄 "),a("strong",[s._v("PATH 檢查及確認己安裝")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ which pg_ctl\n/home/alanjui/Applications/PostgreSQL/9.6/bin/pg_ctl\n")])])]),a("p",[a("strong",[s._v("檢查 Service ，確認是否已啟動")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ service postgresql-9.6 status\n")])])]),a("p",[a("strong",[s._v("檢查 psql shell (PostgreSQL Client) 可連上 PostgreSQL Server")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ pgsql -h 127.0.0.1 -U postgres\n\n$ pgsql -h localhost -U postgres\n\n$ pgsql -h 192.168.66.10 -U postgres\n")])])]),a("p",[a("strong",[s._v("檢查 Port: 5432 是否已在使用中")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ netstat -tulnp | grep 5432\n")])])]),a("hr"),s._v(" "),a("h1",{attrs:{id:"pgadmin4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pgadmin4"}},[s._v("#")]),s._v(" pgAdmin4")]),s._v(" "),a("h2",{attrs:{id:"安裝方法一"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安裝方法一"}},[s._v("#")]),s._v(" 安裝方法一")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n\n$ cat /etc/apt/sources.list.d/pgdg.list                                 \ndeb http://apt.postgresql.org/pub/repos/apt/ xenial-pgdg main\n")])])]),a("p",[s._v("下載 Repository Key ：  https://www.postgresql.org/media/keys/ACCC4CF8.asc")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo apt-get install wget ca-certificates\n$ wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -\n$ sudo apt-get update\n$ sudo apt-get upgrade\n$ sudo apt-get install pgadmin4\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"安裝方法二"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安裝方法二"}},[s._v("#")]),s._v(" 安裝方法二")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo apt-get install virtualenv python-pip libpq-dev python-dev\n\n$ cd\n$ virtualenv pgadmin4\n$ cd pgadmin4\n$ source bin/activate\n\n$ wget https://ftp.postgresql.org/pub/pgadmin/pgadmin4/v1.6/pip/pgadmin4-1.6-py2.py3-none-any.whl\n\n$ pip install pgadmin4-1.6-py2.py3-none-any.whl\n")])])]),a("h2",{attrs:{id:"設定作業"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#設定作業"}},[s._v("#")]),s._v(" 設定作業")]),s._v(" "),a("p",[a("strong",[s._v("設定 SERVER_MODE")])]),s._v(" "),a("p",[s._v("於設定檔： "),a("code",[s._v("~/pgadmin4/lib/python2.7/site-packages/pgadmin4/config_local.py")]),s._v(" 加入「"),a("code",[s._v("SERVER_MODE = False")]),s._v("」設定（run in single-user mode）：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('$ echo "SERVER_MODE = False" >> lib/python2.7/site-packages/pgadmin4/config_local.py\n')])])]),a("p",[a("strong",[s._v("在 Shell 設定「別名(alias)」")])]),s._v(" "),a("p",[s._v("修改下列設定檔：")]),s._v(" "),a("ul",[a("li",[s._v("~/.zshrc")]),s._v(" "),a("li",[s._v("~/.bashrc")]),s._v(" "),a("li",[a("h1",{attrs:{id:"pgadmin4-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pgadmin4-2"}},[s._v("#")]),s._v(" pgAdmin4")]),s._v("\nalias pgadmin='source ~/pgadmin4/bin/activate  && python ~/pgadmin4/lib/python2.7/site-packages/pgadmin4/pgAdmin4.py'")])]),s._v(" "),a("p",[s._v("啟動 pgAdmin4")]),s._v(" "),a("p",[s._v("（１）在終端機執行指令(alias: pgadmin)")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ pgadmin\n")])])]),a("p",[s._v("（２）在 Web Browser 瀏覽網址： http://127.0.0.1:5050/")]),s._v(" "),a("hr"),s._v(" "),a("h1",{attrs:{id:"資料庫管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#資料庫管理"}},[s._v("#")]),s._v(" 資料庫管理")]),s._v(" "),a("h2",{attrs:{id:"建置專案用資料庫"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#建置專案用資料庫"}},[s._v("#")]),s._v(" 建置專案用資料庫")]),s._v(" "),a("p",[a("strong",[s._v("建立使用者帳戶")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo -u postgres createuser django2_helloworld -P\n")])])]),a("p",[s._v("-P 表 Password，當要求輸入 password 時，輸入： "),a("strong",[s._v("Passw0rd")]),s._v(" 。")]),s._v(" "),a("p",[a("strong",[s._v("建立資料庫並設定使用者帳戶")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ sudo -u postgres createdb django2_helloworld_db -O django2_helloworld\n")])])]),a("p",[s._v("-O: Owner")]),s._v(" "),a("p",[s._v("DB URL:  post")]),s._v(" "),a("h2",{attrs:{id:"建置-mail-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#建置-mail-server"}},[s._v("#")]),s._v(" 建置 Mail Server")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("sudo -u postgres createuser mail_server -P\nsudo -u postgres createdb mail_server_db -O mail_server\n\n\npostgresql://\\[user[:password]@\\][netloc]\\[:port\\][/dbname][?param1=value1&...]\n\n\n\nHere are examples from same document\npostgresql://\npostgresql://localhost\npostgresql://localhost:5432\npostgresql://localhost/mydb\npostgresql://user@localhost\npostgresql://user:secret@localhost\npostgresql://other@localhost/otherdb?connect_timeout=10&application_name=myapp\npostgresql://localhost/mydb?user=other&password=secret\n\n\npostgresql://mail_server:Passw0rd@192.168.66.10:5432/mail_server_db\n\n\n\n# vim /opt/postfixadmin/config.local.php\n\n<?php\n$CONF['database_type'] = 'mysqli';\n$CONF['database_user'] = 'postfix';\n$CONF['database_password'] = 'postfix-db-password';\n$CONF['database_name'] = 'postfix';\n\n$CONF['configured'] = true;\n?>\n\n\n# vim /opt/postfixadmin/config.local.php\n\n<?php\n$CONF['database_type'] = 'pgsql';\n$CONF['database_user'] = 'mail_server';\n$CONF['database_password'] = 'Passw0rd';\n$CONF['database_name'] = 'mail_server_db';\n\n$CONF['configured'] = true;\n?>\n")])])]),a("h1",{attrs:{id:"安裝-lepp-伺服器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安裝-lepp-伺服器"}},[s._v("#")]),s._v(" 安裝 LEPP 伺服器")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('$ sudo -u postgres psql postgres\npsql (11.2 (Ubuntu 11.2-1.pgdg18.04+1))\nType "help" for help.\npostgres=# create user "www-data" with password \'Passw0rd\';\nCREATE ROLE\npostgres=# create database lepp_db with owner "www-data";\nCREATE DATABASE\npostgres=# grant all privileges on database lepp_db to "www-data";\nGRANT\npostgres=# \\q\nalanjui@SRV-01:~$\n\n\n$ sudo apt install postfix-pgsql sasl2-bin\n')])])]),a("h1",{attrs:{id:"psql-shell-操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#psql-shell-操作"}},[s._v("#")]),s._v(" PSQL Shell 操作")]),s._v(" "),a("h2",{attrs:{id:"登入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#登入"}},[s._v("#")]),s._v(" 登入")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("psql -h <IP/Host> -d <Database> -U <UserAccount>\n")])])]),a("p",[s._v("登入 localhost")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('alanjui at Srv-01 in [~]   \n10:55:31 $ psql -h localhost -d postgres -U postgres\npsql.bin (9.6.3)\nType "help" for help.\n\nCannot read termcap database;\nusing dumb terminal settings.\npostgres=# quit()\npostgres-# \\q\n')])])]),a("p",[s._v("登入 192.168.66.10:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('alanjui at Srv-01 in [~]   \n11:03:56 $ psql -h 192.168.66.10 -d postgres -U postgres\nPassword for user postgres: \npsql.bin (9.6.3)\nType "help" for help.\n\nCannot read termcap database;\nusing dumb terminal settings.\npostgres=# \n')])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"常用指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用指令"}},[s._v("#")]),s._v(" 常用指令")]),s._v(" "),a("p",[a("strong",[s._v("條列所有 Database")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\list (\\l)\n")])])]),a("p",[a("strong",[s._v("切換「使用中的 Database」")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\connect <database>  (\\c)\n")])])]),a("p",[a("strong",[s._v("條列 Database 所有的 Table")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("\\dt\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"退出psql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#退出psql"}},[s._v("#")]),s._v(" 退出PSQL")]),s._v(" "),a("p",[s._v("使用 \\q 指令。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('alanjui at Srv-01 in [~]   \n9:30:56 $ psql\npsql.bin (9.6.3)\nType "help" for help.\n\nCannot read termcap database;\nusing dumb terminal settings.\nalanjui=# \\q\n\nalanjui at Srv-01 in [~]   \n10:53:43 $ \n')])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"在正式資料庫伺服器建立資料庫及管理員"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在正式資料庫伺服器建立資料庫及管理員"}},[s._v("#")]),s._v(" 在正式資料庫伺服器建立資料庫及管理員")]),s._v(" "),a("p",[s._v("在正式環境的 PostgreSQL ，建立資料庫，並指派資料庫之管理員帳號。")]),s._v(" "),a("p",[a("strong",[s._v("(1) Change the user to postgres :")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("su - postgres\n")])])]),a("p",[a("strong",[s._v("(2) Create User for Postgres")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ createuser testuser\n")])])]),a("p",[a("strong",[s._v("(3) Create Database")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ createdb testdb\n")])])]),a("p",[a("strong",[s._v("(4) Access the postgres Shell")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("psql ( enter the password for postgressql)\n")])])]),a("p",[a("strong",[s._v("(5) Provide the privileges to the postgres user")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ alter user testuser with encrypted password 'qwerty';\n$ grant all privileges on database testdb to testuser;\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"在開發資料庫伺服器建立資料庫及管理員"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在開發資料庫伺服器建立資料庫及管理員"}},[s._v("#")]),s._v(" 在開發資料庫伺服器建立資料庫及管理員")]),s._v(" "),a("p",[s._v("在開發環境用 PostgreSQL 伺服器，建立資料庫及使用者帳號。開發環境的 PostgreSQL ，系以 Docker Image 架設而成。")]),s._v(" "),a("p",[s._v("進入  "),a("strong",[s._v("psql  shell")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("docker ps\ndocker run -it --rm --link psql-db:postgres postgres psql -h postgres -U postgres\n")])])]),a("p",[a("strong",[s._v("建立資料庫")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("CREATE DATABASE [Database]\n")])])]),a("p",[a("strong",[s._v("建立使用者帳號")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("CREATE USER [User] WITH PASSWORD [Password];\n")])])]),a("p",[a("strong",[s._v("指派資料庫的管理員")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("GRANT ALL PRIVILEGES ON DATABASE [Database] to [User];\n")])])]),a("p",[a("strong",[s._v("Revoke privileges from a user")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("REVOKE ALL PRIVILEGES ON [Database] FROM [User|readonly];\n")])])]),a("p",[a("strong",[s._v("刪除使用者帳號")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("DROP USER [User|readonly];\n\n\n\nGRANT ALL ON SEQUENCE public.pups_id_seq TO webapp WITH GRANT OPTION;\nGRANT ALL ON TABLE public.pups TO webapp WITH GRANT OPTION;\n")])])]),a("p",[s._v("操作範例：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ docker run -it --rm --link psql-db:postgres postgres psql -h postgres -U postgres\nPassword for user postgres: \npsql (10.4 (Debian 10.4-2.pgdg90+1))\nType \"help\" for help.\n\npostgres=#\n...\npostgres=# create database django2_helloworld_qa;\nCREATE DATABASE\npostgres=# create user webapp with password 'Passw0rd';\nCREATE ROLE\npostgres=# grant all privileges on database django2_helloworld_qa to webapp;\nGRANT\npostgres=# \\q\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"import-csv-檔案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#import-csv-檔案"}},[s._v("#")]),s._v(" Import CSV 檔案")]),s._v(" "),a("p",[s._v("以下之操作，透過 pgAdmin 4 V2 的 Query Tool 執行")]),s._v(" "),a("p",[s._v("（1）"),a("strong",[s._v("先建立 Table")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("CREATE TABLE persons\n(\n  id serial NOT NULL,\n  first_name character varying(50),\n  last_name character varying(50),\n  dob date,\n  email character varying(255),\n  CONSTRAINT persons_pkey PRIMARY KEY (id)\n)\n")])])]),a("p",[a("strong",[s._v("（2）匯入 CSV 資料檔")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("COPY persons(first_name, last_name, dob, email) \nFROM '/Users/AlanJui/data/csv/persons.csv' DELIMITER ',' CSV HEADER;\n")])])]),a("p",[s._v("【註】：  在 Query Tool 的認定： “~/data” 不等同 “/Users/AlanJui/data” ，所以檔案的路徑不能簡寫成 “~/data/csv/persons.csv” 。")]),s._v(" "),a("p",[s._v("參考： http://www.postgresqltutorial.com/import-csv-file-into-posgresql-table/")]),s._v(" "),a("h2",{attrs:{id:"自-table-匯出成-csv-檔案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自-table-匯出成-csv-檔案"}},[s._v("#")]),s._v(" 自 Table 匯出成 csv 檔案")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("copy public.persons (first_name, last_name, dob, email) \nTO '/Users/AlanJui/data/csv/persons_out.csv' CSV HEADER;\n")])])]),a("p",[s._v("參考： http://www.postgresqltutorial.com/export-postgresql-table-to-csv-file/")]),s._v(" "),a("p",[s._v("在「終端機」使用下列指令：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("AlanJui at MacBook-Pro.local in [/usr/local]\n19:17:18 $ psql --command \"copy public.persons (first_name, last_name, dob, email) TO '/Users/AlanJui/data/csv/persons_out.csv' CSV HEADER;\"\nCOPY 3\n\nAlanJui at MacBook-Pro.local in [/usr/local]\n19:18:11 $ cat ~/data/csv/persons_out.csv\nfirst_name,last_name,dob,email\nAlan, Jui,1960-09-25, alanjui.1960@gmail.com\nStacy, Wu,1967-08-18, stacywu88@gmail.com\nAmos, Jui,2004-06-04, juchuling@gmail.com\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"create-database"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-database"}},[s._v("#")]),s._v(" Create Database")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("CREATE DATABASE learning\n    WITH \n    OWNER = alanjui\n    ENCODING = 'UTF8'\n    CONNECTION LIMIT = -1;\n")])])]),a("hr"),s._v(" "),a("h1",{attrs:{id:"faq"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#faq"}},[s._v("#")]),s._v(" FAQ")]),s._v(" "),a("h2",{attrs:{id:"無法連上-postgresql-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#無法連上-postgresql-server"}},[s._v("#")]),s._v(" 無法連上 PostgreSQL Server")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://d2mxuefqeaa7sj.cloudfront.net/s_B5D84C4CD091B402741E9B2DC97DB9F649A1F2200CF14975E381CC7C9BCE25F5_1500778899268_image.png",alt:""}})]),s._v(" "),a("p",[s._v("Unable to connect to server:")]),s._v(" "),a("p",[s._v('FATAL: no pg_hba.conf entry for host "192.168.66.110", user "postgres", database "postgres", SSL off')]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("上述問題係 PostgreSQL 尚未設定成允許 Remote 連線及條件。")]),s._v(" "),a("p",[s._v("（1）檢查設定檔 "),a("code",[s._v("postgresql.conf")]),s._v(" ，確定任何一個 IP ，都可發出連線要求：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("listen_addresses = '*'\n")])])]),a("p",[s._v("（2）檢查設定檔 "),a("code",[s._v("pg_hba.conf")]),s._v(" ，確定已設定可供連線的 Host 、資料庫、使用者、IP、身份驗證法")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('# TYPE  DATABASE        USER            ADDRESS                 METHOD\n\n# "local" is for Unix domain socket connections only\nlocal   all             all                                     trust\n# IPv4 local connections:\nhost    all             all             127.0.0.1/32            trust\n# IPv6 local connections:\nhost    all             all             ::1/128                 trust\n\nhost    all             all             192.168.66.0/24         md5\nhost    all             all             192.168.66.110/32       trust\n#host    all             all             0.0.0.0/0               md5 \n')])])]),a("p",[s._v("（3）重新啟動 PostgreSQL Service")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ service postgresql-9.6 restart\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"無法進行-db-query"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#無法進行-db-query"}},[s._v("#")]),s._v(" 無法進行 DB Query")]),s._v(" "),a("p",[s._v("得到錯誤訊息：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("Error: permission denied for relation pups at Connection.parseE ….\n")])])]),a("p",[s._v("使用 pgAdmin 4 (V2) 在 psql shell (非在 Query Tools） 進行如下設定：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("CREATE USER readonly  WITH ENCRYPTED PASSWORD 'readonly';\nGRANT USAGE ON SCHEMA public to readonly;\nALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO readonly;\n\n-- repeat code below for each database:\n\nGRANT CONNECT ON DATABASE puppies to readonly;\n\\c puppies\nALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO readonly; --- this grants privileges on new tables generated in new database \"puppies\"\nGRANT USAGE ON SCHEMA public to readonly; \nGRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO readonly;\nGRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;\n")])])]),a("hr"),s._v(" "),a("h2",{attrs:{id:"docker-compose-and-django"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-and-django"}},[s._v("#")]),s._v(" Docker Compose and Django")]),s._v(" "),a("p",[s._v("有時候，在 docker compose 中的 db 被玩壞了， ./manage.py migrate 再也無法正常運作之時，可以透過以下的方式重建 Database: postgres 。")]),s._v(" "),a("p",[a("strong",[s._v("(1) 清除所有 migrations")]),s._v("\n執行以下指令之前，先將「目錄」選在 "),a("Project",{attrs:{Rooot:""}},[s._v(" 目錄。")])],1),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('$ find . -path "*/migrations/*.py" -not -name "__init__.py" -delete\n$ find . -path "*/migrations/*.pyc"  -delete\n')])])]),a("p",[a("strong",[s._v("(2) 進入 docker-compose 中的 db container")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ docker-copose up\n$ docker-compose exec db bash\n")])])]),a("p",[a("strong",[s._v("(3) 刪除 Database: postgres")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ dropdb -h localhost -p 5432 -U postgres postgres\n")])])]),a("p",[a("strong",[s._v("(4) 重建 Database: postgres")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ createdb -h localhost -p 5432 -U postgres postgres\n")])])]),a("p",[a("strong",[s._v("(5) 驗證")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("$ psql -h localhost -p 5432 -U postgres\npostgres=# \\l\n                                 List of databases\n   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges\n-----------+----------+----------+------------+------------+-----------------------\n postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |\n template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +\n           |          |          |            |            | postgres=CTc/postgres\n template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +\n           |          |          |            |            | postgres=CTc/postgres\n(3 rows)\n\npostgres=#\\q\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);